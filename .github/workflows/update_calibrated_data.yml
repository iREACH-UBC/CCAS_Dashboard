name: Update Calibrated Sensor Data

on:
  workflow_run:
    workflows: ["Update Sensor Data"]
    types: [completed]
  workflow_dispatch:

defaults:
  run:
    shell: bash

env:
  R_LIBS_USER: ${{ github.workspace }}/.Rlib
  RENV_CONFIG_AUTOLOADER_ENABLED: "FALSE"            # no renv autoload
  RSPM: "https://packagemanager.posit.co/cran/__linux__/focal/latest"

jobs:
# ──────────────────────────────── RAMP ────────────────────────────────
  calibrate-ramp:
    runs-on: ubuntu-latest

    steps:
      # 1. checkout
      - uses: actions/checkout@v4
        with: { persist-credentials: true }

      # 2. cache compiled pkgs
      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key:  ${{ runner.os }}-r-lib-${{ hashFiles('scripts/calibrate_data.R') }}
          restore-keys: ${{ runner.os }}-r-lib-

      # 3. set up R
      - uses: r-lib/actions/setup-r@v2

      # 4. Install packages in a safe three-phase order -----------------------
      - name: Install R packages
        run: |
          # helper to install a set of pkgs as binaries
          install_bin () {
            Rscript -e "pkgs <- commandArgs(TRUE); \
              inst <- setdiff(pkgs, rownames(installed.packages())); \
              if (length(inst)) install.packages(inst, repos = Sys.getenv('RSPM'), quiet = TRUE)" "$@"
          }

          # ---- phase 0: always purge any cached binary stringi --------------
          rm -rf "$R_LIBS_USER/stringi"

          # ---- phase 1: lightweight binaries (everything except stringr/terra/raster) ----
          install_bin dplyr readr lubridate purrr tibble fs zoo openair glue randomForest

          # ---- phase 2: build stringi from source to fix ICU mismatch -------
